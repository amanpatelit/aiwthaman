name: Deploy to AWS S3

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  request-approval:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Slack notification - Approval Required
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"‚ö†Ô∏è *Deployment Approval Required*\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"‚ö†Ô∏è Deployment Approval Required\",
                  \"emoji\": true
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Repository:*\n${{ github.repository }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Branch:*\n${{ github.ref_name }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Triggered by:*\n${{ github.actor }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:*\n\`${SHORT_SHA}\`\"
                  }
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit Message:*\n${COMMIT_MSG}\"
                }
              },
              {
                \"type\": \"divider\"
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîî *Action Required:* Click the button below to review and approve this deployment\"
                },
                \"accessory\": {
                  \"type\": \"button\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"Review & Approve\",
                    \"emoji\": true
                  },
                  \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                  \"style\": \"primary\"
                }
              }
            ]
          }"

  deploy:
    runs-on: ubuntu-latest
    needs: request-approval
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Slack notification - Deployment Approved & Started
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"‚úÖ *Deployment Approved - Starting Now*\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"‚úÖ Deployment Approved & Started\",
                  \"emoji\": true
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Repository:*\n${{ github.repository }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Branch:*\n${{ github.ref_name }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Approved by:*\n${{ github.actor }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:*\n\`${SHORT_SHA}\`\"
                  }
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üöÄ Deployment is now in progress...\"
                }
              }
            ]
          }"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Sync files to S3
        run: |
          aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }} \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "README.md" \
            --delete

      - name: Invalidate CloudFront cache (optional)
        continue-on-error: true
        run: |
          if [ ! -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"
            echo "CloudFront cache invalidated"
          else
            echo "CloudFront distribution ID not set, skipping cache invalidation"
          fi

      - name: Deployment complete
        run: echo "Website deployed successfully to S3!"

      - name: Send Slack notification - Deployment Success
        if: success()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"‚úÖ *Deployment Successful*\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"‚úÖ Deployment Successful\",
                  \"emoji\": true
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Repository:*\n${{ github.repository }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Branch:*\n${{ github.ref_name }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:*\n\`${SHORT_SHA}\`\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Status:*\nüéâ Success\"
                  }
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit Message:*\n${COMMIT_MSG}\"
                }
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Details>\"
                }
              }
            ]
          }"

      - name: Send Slack notification - Deployment Failed
        if: failure()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"‚ùå *Deployment Failed*\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"‚ùå Deployment Failed\",
                  \"emoji\": true
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Repository:*\n${{ github.repository }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Branch:*\n${{ github.ref_name }}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:*\n\`${SHORT_SHA}\`\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Triggered by:*\n${{ github.actor }}\"
                  }
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"‚ö†Ô∏è *Error:* Deployment failed. Please check the logs for details.\"
                }
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Error Logs>\"
                }
              }
            ]
          }"
